// unit tests for events.middleware.get
'use strict';
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const testdouble_1 = __importDefault(require("testdouble"));
const restify_1 = __importDefault(require("restify"));
const parse_http_params_1 = require("../src/parse-http-params");
const chai_1 = require("chai");
const { anything, isA } = testdouble_1.default.matchers;
const { verify, when } = testdouble_1.default;
const calledOnce = { times: 1, ignoreExtraArgs: true };
describe('events.middleware.get', () => {
    let poll;
    let store;
    let middleware;
    let log;
    let req;
    let res;
    let next;
    const FAILING_LOAD_CHANNEL = 'failing-load-channel';
    const EMPTY_CHANNEL = 'empty-channel';
    const NON_EMPTY_CHANNEL = 'non-empty-channel';
    const NON_EMPTY_EVENT = { id: 2 };
    const TRIGGER_CHANNEL = 'trigger-channel';
    const TRIGGER_EVENT = { id: 1 };
    const FAILING_POLL_CHANNEL = 'failing-poll-channel';
    const testChannels = {};
    // NON_EMPTY_CHANNEL:
    //  - has 1 event
    testChannels[NON_EMPTY_CHANNEL] = () => {
        when(store.loadEvents(NON_EMPTY_CHANNEL, anything()))
            .thenCallback(null, [NON_EMPTY_EVENT]);
    };
    // FAILING_LOAD_CHANNEL:
    //  - loading fails with a InternalServerError
    testChannels[FAILING_LOAD_CHANNEL] = () => {
        when(store.loadEvents(FAILING_LOAD_CHANNEL, anything()))
            .thenCallback(new restify_1.default.InternalServerError());
    };
    // FAILING_POLL_CHANNEL:
    //  - has no events
    //  - polling will fail
    testChannels[FAILING_POLL_CHANNEL] = () => {
        when(store.loadEvents(FAILING_POLL_CHANNEL, anything()))
            .thenCallback(null, []);
        when(poll.listen(FAILING_POLL_CHANNEL))
            .thenCallback(new Error('poll.listen failed'));
    };
    // EMPTY_CHANNEL:
    //  - has no events
    //  - polling will timeout
    testChannels[EMPTY_CHANNEL] = () => {
        when(store.loadEvents(EMPTY_CHANNEL, anything()))
            .thenCallback(null, []);
        when(poll.listen(EMPTY_CHANNEL))
            .thenCallback(null, null);
    };
    // TRIGGER_CHANNEL:
    //  - has no events initially
    //  - polling will trigger a message,
    //  - then it will have 1 event
    testChannels[TRIGGER_CHANNEL] = () => {
        when(store.loadEvents(TRIGGER_CHANNEL, anything()))
            .thenCallback(null, []);
        when(poll.listen(TRIGGER_CHANNEL, anything()))
            .thenDo((channel, callback) => {
            when(store.loadEvents(TRIGGER_CHANNEL, anything()))
                .thenCallback(null, [TRIGGER_EVENT]);
            callback(null, TRIGGER_EVENT.id);
        });
    };
    beforeEach(() => {
        store = testdouble_1.default.object(['loadEvents']);
        when(store.loadEvents(anything(), anything()))
            .thenCallback(new Error('unexpected store.loadEvents'));
        poll = testdouble_1.default.object(['listen']);
        when(poll.listen(anything(), anything()))
            .thenCallback(new Error('unexpected poll.listen'));
        log = testdouble_1.default.object(['error']);
        middleware = require('../src/events.middleware.get')
            .createMiddleware({ poll, store, log });
        const input = validInput();
        req = input.req;
        res = input.res;
        next = input.next;
    });
    const validRequest = () => ({
        params: {
            clientId: 'test-client',
            channel: 'channel',
            after: '0',
            limit: '100'
        }
    });
    const validInput = () => ({
        req: validRequest(),
        res: testdouble_1.default.object(['json']),
        next: testdouble_1.default.function('next')
    });
    const withChannel = (channel) => {
        if (testChannels[channel])
            testChannels[channel]();
        req.params.channel = channel;
        middleware(req, res, next);
    };
    it('fails when channel parameter is undefined', () => {
        withChannel(undefined);
        verify(next(isA(restify_1.default.InvalidContentError)));
        verify(next(), calledOnce);
    });
    it('fails when store.loadEvents fails', () => {
        withChannel(FAILING_LOAD_CHANNEL);
        verify(next(isA(restify_1.default.InternalServerError)));
        verify(next(), calledOnce);
    });
    it('returns events right away when already in store', () => {
        withChannel(NON_EMPTY_CHANNEL);
        verify(res.json([NON_EMPTY_EVENT]));
        verify(next(), calledOnce);
    });
    it('polls for events when there are none in store', () => {
        withChannel(EMPTY_CHANNEL);
        verify(poll.listen(), calledOnce);
    });
    it('responds with an empty array when polling timeout', () => {
        withChannel(EMPTY_CHANNEL);
        verify(res.json([]));
        verify(next(), calledOnce);
    });
    it('responds with the event when a new message is polled', () => {
        withChannel(TRIGGER_CHANNEL);
        verify(poll.listen(), calledOnce);
        verify(res.json([TRIGGER_EVENT]));
        verify(next(), calledOnce);
    });
    it('responds with an InternalServerError when polling fails', () => {
        withChannel(FAILING_POLL_CHANNEL);
        verify(poll.listen(), calledOnce);
        verify(next(isA(restify_1.default.InternalServerError)));
    });
    it('logs polling errors on the console', () => {
        withChannel(FAILING_POLL_CHANNEL);
        verify(log.error(), calledOnce);
    });
    describe('parseGetParams()', () => {
        const clientId = 'test';
        const channel = 'channel';
        it('parses after to be int within [0, MAX_SAFE_INTEGER]', () => {
            const t = (desiredAfter, expected) => {
                const actual = (0, parse_http_params_1.parseGetParams)({ clientId, channel, after: desiredAfter });
                (0, chai_1.expect)(actual['after']).to.equal(expected);
            };
            // acceptable
            t(0, 0);
            t(50, 50);
            t(Number.MAX_SAFE_INTEGER, Number.MAX_SAFE_INTEGER);
            // wierd values default to byDefault
            t(undefined, 0);
            t(-1, 0);
            t('wierd', 0);
            t({}, 0);
            t(Number.MAX_SAFE_INTEGER + 1, 0);
        });
        it('parses liimt to be int within [1, 100]', () => {
            const t = (desiredLimit, expected) => {
                const actual = (0, parse_http_params_1.parseGetParams)({ clientId, channel, limit: desiredLimit });
                (0, chai_1.expect)(actual['limit']).to.equal(expected);
            };
            // acceptable
            t(1, 1);
            t(50, 50);
            t(100, 100);
            // wierd values default to byDefault
            t(undefined, 100);
            t(-1, 100);
            t('wierd', 100);
            t({}, 100);
            t(500, 100);
        });
        it('defaults after/limit to 0/100', () => {
            (0, chai_1.expect)((0, parse_http_params_1.parseGetParams)({ clientId, channel })).to.eql({
                clientId,
                channel,
                after: 0,
                limit: 100,
                afterExplicitlySet: false
            });
        });
        it('client id must be non-empty string', () => {
            const t = (input) => {
                const actual = (0, parse_http_params_1.parseGetParams)(input);
                (0, chai_1.expect)(actual).to.be.instanceof(Error);
                (0, chai_1.expect)(actual.message).to.equal('Invalid Client ID');
            };
            t({ channel });
            t({ clientId: '', channel });
            t({ clientId: 42, channel });
            t({ clientId: false, channel });
            t({ clientId: undefined, channel });
        });
        it('channel must be non-empty string', () => {
            const t = (input) => {
                const actual = (0, parse_http_params_1.parseGetParams)(input);
                (0, chai_1.expect)(actual).to.be.instanceof(Error);
                (0, chai_1.expect)(actual.message).to.equal('Invalid Channel');
            };
            t({ clientId });
            t({ channel: '', clientId });
            t({ channel: 42, clientId });
            t({ channel: false, clientId });
            t({ channel: undefined, clientId });
        });
        it('afterExplicitlySet is true, when after is found in params', () => {
            (0, chai_1.expect)((0, parse_http_params_1.parseGetParams)({ channel, clientId, after: '1' })).to.have.property('afterExplicitlySet', true);
            (0, chai_1.expect)((0, parse_http_params_1.parseGetParams)({ channel, clientId })).to.have.property('afterExplicitlySet', false);
        });
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXZlbnRzLm1pZGRsZXdhcmUuZ2V0LnRlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi90ZXN0cy9ldmVudHMubWlkZGxld2FyZS5nZXQudGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSx1Q0FBdUM7QUFFdkMsWUFBWSxDQUFDOzs7OztBQUViLDREQUE0QjtBQUM1QixzREFBOEI7QUFDOUIsZ0VBQXdEO0FBQ3hELCtCQUE0QjtBQUM1QixNQUFNLEVBQUMsUUFBUSxFQUFFLEdBQUcsRUFBQyxHQUFHLG9CQUFFLENBQUMsUUFBUSxDQUFDO0FBQ3BDLE1BQU0sRUFBQyxNQUFNLEVBQUUsSUFBSSxFQUFDLEdBQUcsb0JBQUUsQ0FBQztBQUMxQixNQUFNLFVBQVUsR0FBRyxFQUFDLEtBQUssRUFBRSxDQUFDLEVBQUUsZUFBZSxFQUFFLElBQUksRUFBQyxDQUFDO0FBRXJELFFBQVEsQ0FBQyx1QkFBdUIsRUFBRSxHQUFHLEVBQUU7SUFDckMsSUFBSSxJQUFJLENBQUM7SUFDVCxJQUFJLEtBQUssQ0FBQztJQUNWLElBQUksVUFBVSxDQUFDO0lBQ2YsSUFBSSxHQUFHLENBQUM7SUFDUixJQUFJLEdBQUcsQ0FBQztJQUNSLElBQUksR0FBRyxDQUFDO0lBQ1IsSUFBSSxJQUFJLENBQUM7SUFFVCxNQUFNLG9CQUFvQixHQUFHLHNCQUFzQixDQUFDO0lBQ3BELE1BQU0sYUFBYSxHQUFHLGVBQWUsQ0FBQztJQUN0QyxNQUFNLGlCQUFpQixHQUFHLG1CQUFtQixDQUFDO0lBQzlDLE1BQU0sZUFBZSxHQUFHLEVBQUMsRUFBRSxFQUFFLENBQUMsRUFBQyxDQUFDO0lBQ2hDLE1BQU0sZUFBZSxHQUFHLGlCQUFpQixDQUFDO0lBQzFDLE1BQU0sYUFBYSxHQUFHLEVBQUMsRUFBRSxFQUFFLENBQUMsRUFBQyxDQUFDO0lBQzlCLE1BQU0sb0JBQW9CLEdBQUcsc0JBQXNCLENBQUM7SUFFcEQsTUFBTSxZQUFZLEdBQUcsRUFBRSxDQUFDO0lBRXhC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